// These styles are compiled into a grid class system

$columns: 12 !default;
$media: screen !default;



// basic width calculations
@function normal-width($number) {
	@return $size-bit * $number + $margin-bit * ($number - 1);
}

@function small-width($number) {
	@return $size-bit * $number * 2 + $margin-bit * ($number * 2 - 1);
}

@function small-companion-width($number) {
	// determine how big is a sibling of big paired blocks
	$companion: $columns - $number;
	@return $size-bit * $companion * 2 + $margin-bit * ($companion * 2 - 1);
}

@function mobile-width($number) {
	@return $size-bit * $number * 4 + $margin-bit * ($number * 4 - 1);
}

@function mobile-companion-width($number) {
	// determine how big is a sibling of big paired blocks
	$companion: $columns - $number;
	@return $size-bit * $companion * 4 + $margin-bit * ($companion * 4 - 1);
}


@mixin grid-item($nth) {

	// calculating how many items can be fit into a row
	$item-per-column: $columns / $nth;
	$small-item-per-column: $item-per-column / 2;
	$mobile-item-per-column: $item-per-column / 4;



	// calculate different sizes for regular, tablet and mobile view.
	$width: normal-width($nth);
	$small-width:  small-width($nth);
	$mobile-width: mobile-width($nth);
	$small-companion-width: small-companion-width($nth);
	$mobile-companion-width: mobile-companion-width($nth);


	// set an item width (this is the only one IE8 will ever accept)
	width: $width;


	// if several items of the same class can fill a row without remainder
	@if ($item-per-column == round($columns / $nth)) {
		// start from a new row
		&:nth-of-type(#{$item-per-column}n+#{$item-per-column}), &:last-child {
			margin-right: 0;
		}

		@if $media == screen {
			@include breakpoint(small) {
				// for tablet view, bigger than half a row items forced to fill whole row
				@if ($width < 32%) {
					width: $small-width;
					&:nth-of-type(#{$small-item-per-column}n+#{$small-item-per-column}) {
						margin-right: 0;
					}
				}

				@else if ($width >= 32% and $width < 75%){
					width: 49%;
					&:nth-of-type(#{$item-per-column}n+#{$item-per-column}) {
						margin-right: $margin-bit;
						&:after {
							clear:none;
						}
					}
					&:nth-of-type(2n+2) {
						margin-right: 0;
					}
				}
				@else {
					width: 100%;
				}
			}
			@include breakpoint(mobile) {
				// for mobile view, bigger than half a row items forced to fill whole row
				@if ($mobile-width > 50%) {
					width: 100%;
				}
				@else {
					width: $mobile-width;
				}
				// start from a new row
				&:nth-of-type(#{$mobile-item-per-column}n+#{$mobile-item-per-column}) {
					margin-right: 0;
				}
			}
		}
	}
	// if several items of the same class cannot fill a row without remainder, calculate its likeliest compainion width and fill the space
	@else {
		@if $media == screen {
			@include breakpoint(small) {
				$small-width: 100% - $margin-bit - $small-companion-width;
				// make sure those items whose companion are forced to fill whole row also fill the row
				@if ($small-width + $margin-bit < 50%) {
					width: 100%;
				}
				@else {
					width: $small-width;
				}
			}
			@include breakpoint(mobile) {
				// make sure those items whose companion are forced to fill whole row also fill the row
				$mobile-width: 100% - $margin-bit - $mobile-companion-width;
				@if ($mobile-width + $margin-bit < 50%) {
					width: 100%;
				}
				@else {
					width: $mobile-width;
				}
			}
		}

		&:last-child {
			margin-right: 0;
		}
	}
}


// make silent grid classes col-1, col-2... until col-N, where N is number of columns
@for $i from 1 to $columns+1 {
	%col-#{$i} {
		@extend %column;
		@include grid-item($i);
	}
}

%column {
	position: relative;
	margin-right: calc(#{$margin-bit} - .35em);
}

// grid helpers
%inblock {
	@include inline-block(top);
}